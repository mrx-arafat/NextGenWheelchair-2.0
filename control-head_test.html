<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <!-- theme meta -->
    <meta name="theme-name" content="quixlab" />

    <title>NextGen WheelChair - System Status</title>
    <!-- Favicon icon -->
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicon.png" />
    <!-- Pignose Calender -->
    <link
      href="./plugins/pg-calendar/css/pignose.calendar.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css"
    />
    <!-- Chartist -->
    <link rel="stylesheet" href="./plugins/chartist/css/chartist.min.css" />
    <link
      rel="stylesheet"
      href="./plugins/chartist-plugin-tooltips/css/chartist-plugin-tooltip.css"
    />
    <!-- Custom Stylesheet -->
    <link href="css/style.css" rel="stylesheet" />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-KyZXEAg3QhqLMpG8r+Knujsl5//V4dCI4ZZh5g0m5Q5Q5Y5mDmE4jKf+Wlp2GTx/"
      crossorigin="anonymous"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-cn7l7gDp0eyniUwwAZgrzD06kc/tftFf19TOAs2zVinnD/C7E91j9yyk5//jjpt/"
      crossorigin="anonymous"
    ></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/clmtrackr/1.1.1/clmtrackr.min.js"></script> -->

    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.1.1/dist/face-api.min.js"></script>

    <style>
      #webcam {
        transform: scaleX(-1);
      }

      #overlay {
        position: absolute;
        top: 0;
        left: 0;
        transform: scaleX(-1);
        pointer-events: none;
      }
    </style>
  </head>

  <body>
    <!--*******************
        Preloader start
    ********************-->
    <div id="preloader">
      <div class="loader">
        <svg class="circular" viewBox="25 25 50 50">
          <circle
            class="path"
            cx="50"
            cy="50"
            r="20"
            fill="none"
            stroke-width="3"
            stroke-miterlimit="10"
          />
        </svg>
      </div>
    </div>
    <!--*******************
        Preloader end
    ********************-->

    <!--**********************************
        Main wrapper start
    ***********************************-->
    <div id="main-wrapper">
      <!--**********************************
            Nav header start
        ***********************************-->

      <div class="nav-header">
        <div class="brand-logo">
          <a href="#">
            <span class="logo-abbr"
              ><img src="images/logo.svg" alt="" width="35" />
            </span>
            <span class="logo-compact">
              <img src="images/logo.svg" alt="" width="35" />
            </span>
            <span class="brand-title">
              <div class="container-fluid">
                <div class="row">
                  <div class="col-3">
                    <img src="images/logo.svg" alt="" width="35" />
                  </div>
                  <div class="col-">
                    <span
                      style="
                        font-size: 13px;
                        color: whitesmoke;
                        font-family: cursive;
                      "
                    >
                      <b>NextGenWheelchair</b>
                    </span>
                  </div>
                </div>
              </div>
            </span>
          </a>
        </div>
      </div>
      <!--**********************************
            Nav header end
        ***********************************-->

      <!--**********************************
            Header start
        ***********************************-->
      <div class="header">
        <div class="header-content clearfix">
          <div class="nav-control">
            <div class="hamburger">
              <span class="toggle-icon"><i class="icon-menu"></i></span>
            </div>
          </div>
          <div class="header-right">
            <ul class="clearfix">
              <li class="icons">
                <a>
                  <img
                    src="images/battery-full.png"
                    alt=""
                    style="height: 30px"
                  />
                </a>
              </li>

              <li class="icons dropdown">
                <a href="javascript:void(0)" data-toggle="dropdown">
                  <i class="mdi mdi-bell-outline"></i>
                  <span class="badge badge-pill gradient-2 badge-primary"
                    >3</span
                  >
                </a>
                <div
                  class="drop-down animated fadeIn dropdown-menu dropdown-notfication"
                >
                  <div
                    class="dropdown-content-heading d-flex justify-content-between"
                  >
                    <span class="">2 New Notifications</span>
                  </div>
                  <div class="dropdown-content-body">
                    <ul>
                      <li>
                        <a href="javascript:void()">
                          <span class="mr-3 avatar-icon bg-success-lighten-2"
                            ><i class="icon-present"></i
                          ></span>
                          <div class="notification-content">
                            <h6 class="notification-heading">
                              Events near you
                            </h6>
                            <span class="notification-text"
                              >Within next 5 days</span
                            >
                          </div>
                        </a>
                      </li>
                      <li>
                        <a href="javascript:void()">
                          <span class="mr-3 avatar-icon bg-danger-lighten-2"
                            ><i class="icon-present"></i
                          ></span>
                          <div class="notification-content">
                            <h6 class="notification-heading">Event Started</h6>
                            <span class="notification-text">One hour ago</span>
                          </div>
                        </a>
                      </li>
                      <li>
                        <a href="javascript:void()">
                          <span class="mr-3 avatar-icon bg-success-lighten-2"
                            ><i class="icon-present"></i
                          ></span>
                          <div class="notification-content">
                            <h6 class="notification-heading">
                              Event Ended Successfully
                            </h6>
                            <span class="notification-text">One hour ago</span>
                          </div>
                        </a>
                      </li>
                      <li>
                        <a href="javascript:void()">
                          <span class="mr-3 avatar-icon bg-danger-lighten-2"
                            ><i class="icon-present"></i
                          ></span>
                          <div class="notification-content">
                            <h6 class="notification-heading">Events to Join</h6>
                            <span class="notification-text"
                              >After two days</span
                            >
                          </div>
                        </a>
                      </li>
                    </ul>
                  </div>
                </div>
              </li>

              <li class="icons dropdown">
                <div
                  class="user-img c-pointer position-relative"
                  data-toggle="dropdown"
                >
                  <span class=""></span>
                  <img src="images/user/1.png" height="40" width="40" alt="" />
                </div>
                <div
                  class="drop-down dropdown-profile animated fadeIn dropdown-menu"
                >
                  <div class="dropdown-content-body">
                    <ul>
                      <!-- <li>
                        <a href="app-profile.html"
                          ><i class="icon-user"></i> <span>Profile</span></a
                        >
                      </li> -->
                      <li>
                        <a href="page-login.html"
                          ><i class="icon-key"></i> <span>Logout</span></a
                        >
                      </li>
                    </ul>
                  </div>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <!--**********************************
            Header end ti-comment-alt
        ***********************************-->

      <!--**********************************
            Sidebar start
        ***********************************-->
      <div class="nk-sidebar">
        <div class="nk-nav-scroll">
          <ul class="metismenu" id="menu">
            <!-- <li class="nav-label">Dashboard</li> -->
            <li>
              <a class="" href="system-status.html" aria-expanded="false">
                <i class="icon-speedometer menu-icon"></i
                ><span class="nav-text">System Information</span>
              </a>
            </li>
            <li>
              <a
                class="has-arrow"
                href="javascript:void()"
                aria-expanded="false"
              >
                <!-- <i class="icon-globe-alt menu-icon"></i> -->
                <i class="bi bi-dpad"></i>

                <span class="nav-text">Controls</span>
              </a>
              <ul aria-expanded="false">
                <li>
                  <a href="./control-head.html" id="head motion">Head Motion</a>
                </li>
                <li><a href="./control-voice.html" id="voice">Voice</a></li>
                <li><a href="./control-manual.html" id="manual">Manual</a></li>
              </ul>
            </li>
            <li>
              <a class="" href="page-login.html" aria-expanded="false">
                <i class="bi bi-box-arrow-left"></i>
                <span class="nav-text">Sign Out</span>
              </a>
            </li>
          </ul>
        </div>
      </div>
      <!--**********************************
            Sidebar end
        ***********************************-->

      <!--**********************************
            Content body start-->

      <div class="content-body">
        <div class="clearfix">
          <div class="row" style="padding-top: 30px">
            <div class="col-lg-6 col-md-12">
              <h3 style="margin-left: 25px">Control Method:</h3>
            </div>
            <div
              class="col-lg-6 col-md-12"
              style="padding-top: 15px; padding-right: 40px"
            >
              <!-- Insert Modal -->

              <span class="float-right">
                <h3>Head Motion</h3>
              </span>
            </div>
          </div>
        </div>
        <div class="container-fluid mt-3">
          <div class="card">
            <div class="card-body px-0">
              <div class="row">
                <div class="col-lg-8 col-md-12">
                  <div class="card card-widget">
                    <div class="card-body">
                      <!-- webcam -->

                      <div class="container mt-5">
                        <div class="row">
                          <div class="col-md-12 text-center">
                            <h1>Real-time Feedback with Head Motion</h1>
                            <div class="card">
                              <div class="card-body position-relative">
                                <video
                                  id="webcam"
                                  width="640"
                                  height="480"
                                  autoplay
                                  muted
                                ></video>

                                <canvas
                                  id="overlay"
                                  width="640"
                                  height="480"
                                ></canvas>
                              </div>
                            </div>
                            <div class="mt-3">
                              <button id="startWebcam" class="btn btn-primary">
                                Start Webcam
                              </button>
                              <button
                                id="pauseResume"
                                class="btn btn-secondary"
                              >
                                Pause
                              </button>
                            </div>

                            <!-- info -->

                            <div class="card mt-3">
                              <div class="card-body">
                                <h5 class="card-title">
                                  Head Motion Information
                                </h5>
                                <p id="motionDirection" class="card-text">
                                  Motion Direction: N/A
                                </p>
                                <p id="motionAngle" class="card-text">
                                  Motion Angle: N/A
                                </p>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <!-- end -->
                    </div>
                  </div>
                </div>
                <div class="col-lg-4 col-md-12">
                  <div class="col-xl-12">
                    <div class="card">
                      <div class="card-body">
                        <h2 class="card-title">Head Position Status</h2>
                        <div>
                          <h6>Attention Level:</h6>
                          <div class="progress mb-3" style="height: 25px">
                            <div
                              class="progress-bar bg-success"
                              style="width: 85%"
                              role="progressbar"
                            >
                              85%
                            </div>
                          </div>
                        </div>

                        <div>
                          <!-- <img src="images/arrow-right-active.png" alt="" /> -->
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- #/ container -->
      </div>

      <!--**********************************
            Content body end
        ***********************************-->

      <!--**********************************
            Footer start
        ***********************************-->
      <div class="footer">
        <div class="copyright">
          <p>
            Copyright &copy; Designed & Developed by
            <a href="https://themeforest.net/user/quixlab">KingBob</a> 2018
          </p>
        </div>
      </div>
      <!--**********************************
            Footer end
        ***********************************-->
    </div>
    <!--**********************************
        Main wrapper end
    ***********************************-->

    <!--**********************************
        Scripts
    ***********************************-->
    <script>
      const ws = new WebSocket("ws://192.168.0.101:81");
      console.log("Connected to WebSocket server");

      ws.onopen = function () {
        console.log("WebSocket connection established");
      };

      ws.onmessage = function (event) {
        console.log("Received: " + event.data);
      };

      const startWebcamBtn = document.getElementById("startWebcam");
      const pauseResumeBtn = document.getElementById("pauseResume");
      const videoElement = document.getElementById("webcam");

      async function startWebcam() {
        try {
          const constraints = { video: { facingMode: "user" } };
          const stream = await navigator.mediaDevices.getUserMedia(constraints);
          videoElement.srcObject = stream;
          videoElement.play();
          startWebcamBtn.textContent = "Stop Webcam";
          startWebcamBtn.onclick = stopWebcam;
          startTracking();
        } catch (err) {
          console.error("Error accessing webcam:", err);
        }
      }

      function stopWebcam() {
        const stream = videoElement.srcObject;
        if (stream) {
          const tracks = stream.getTracks();
          tracks.forEach((track) => track.stop());
          videoElement.srcObject = null;
        }
        startWebcamBtn.textContent = "Start Webcam";
        startWebcamBtn.onclick = startWebcam;
        stopTracking();
      }

      function pauseResume() {
        if (videoElement.paused) {
          videoElement.play();
          pauseResumeBtn.textContent = "Pause";
        } else {
          videoElement.pause();
          pauseResumeBtn.textContent = "Resume";
        }
      }

      startWebcamBtn.addEventListener("click", startWebcam);
      pauseResumeBtn.addEventListener("click", pauseResume);

      let previousPosition;

      async function startTracking() {
        await faceapi.nets.tinyFaceDetector.loadFromUri("./models");
        await faceapi.nets.faceLandmark68TinyNet.loadFromUri("./models");

        const faceDetectionOptions = new faceapi.TinyFaceDetectorOptions({
          inputSize: 224,
          scoreThreshold: 0.5,
        });

        const landmarkOptions = { lineWidth: 2, drawLines: true, color: "red" };

        async function detectAndDraw() {
          const detections = await faceapi
            .detectAllFaces(videoElement, faceDetectionOptions)
            .withFaceLandmarks(true);

          const canvas = document.getElementById("overlay");
          const context = canvas.getContext("2d");
          context.clearRect(0, 0, canvas.width, canvas.height);

          faceapi.draw.drawFaceLandmarks(canvas, detections, landmarkOptions);

          if (detections && detections.length > 0 && detections[0].landmarks) {
            const currentPosition = detections[0].landmarks.positions[33];

            if (previousPosition) {
              const deltaX = currentPosition.x - previousPosition.x;
              const deltaY = currentPosition.y - previousPosition.y;
              const motion = Math.sqrt(deltaX * deltaX + deltaY * deltaY);

              if (motion > 10) {
                const direction = getMotionDirection(deltaX, deltaY);
                const angle = getMotionAngle(deltaX, deltaY);
                updateMotionInfo(direction, angle);
              }
            }
            previousPosition = currentPosition;
          }

          setTimeout(detectAndDraw, 100); // Update every (1 second)
        }

        detectAndDraw();
      }

      function stopTracking() {
        const canvas = document.getElementById("overlay");
        const context = canvas.getContext("2d");
        context.clearRect(0, 0, canvas.width, canvas.height);
        previousPosition = null;
      }

      function getMotionDirection(deltaX, deltaY) {
        if (Math.abs(deltaX) > Math.abs(deltaY)) {
          return deltaX > 0 ? "Left" : "Right";
        } else {
          return deltaY > 0 ? "Forward" : "Back";
        }
      }

      function getMotionAngle(deltaX, deltaY) {
        return (Math.atan2(deltaY, deltaX) * 180) / Math.PI;
      }

      function updateMotionInfo(direction, angle) {
        const motionDirectionElement =
          document.getElementById("motionDirection");
        const motionAngleElement = document.getElementById("motionAngle");
        motionDirectionElement.textContent = `Motion Direction: ${direction}`;
        motionAngleElement.textContent = `Motion Angle: ${angle.toFixed(2)}°`;
        const data = {
          direction: direction,
          angle: angle.toFixed(2),
        };
        ws.send(JSON.stringify(data));
      }
    </script>

    <script src="plugins/common/common.min.js"></script>
    <script src="js/custom.min.js"></script>
    <script src="js/settings.js"></script>
    <script src="js/gleek.js"></script>
    <script src="js/styleSwitcher.js"></script>

    <!-- Chartjs -->
    <script src="./plugins/chart.js/Chart.bundle.min.js"></script>
    <!-- Circle progress -->
    <script src="./plugins/circle-progress/circle-progress.min.js"></script>
    <!-- Datamap -->
    <script src="./plugins/d3v3/index.js"></script>
    <script src="./plugins/topojson/topojson.min.js"></script>
    <script src="./plugins/datamaps/datamaps.world.min.js"></script>
    <!-- Morrisjs -->
    <script src="./plugins/raphael/raphael.min.js"></script>
    <script src="./plugins/morris/morris.min.js"></script>
    <!-- Pignose Calender -->
    <script src="./plugins/moment/moment.min.js"></script>
    <script src="./plugins/pg-calendar/js/pignose.calendar.min.js"></script>
    <!-- ChartistJS -->
    <script src="./plugins/chartist/js/chartist.min.js"></script>
    <script src="./plugins/chartist-plugin-tooltips/js/chartist-plugin-tooltip.min.js"></script>

    <script src="./js/dashboard/dashboard-1.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
  </body>
</html>
